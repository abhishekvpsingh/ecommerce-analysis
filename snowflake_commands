-- Step 1: Create a Warehouse
CREATE OR REPLACE WAREHOUSE ECOMMERCE_WH
WITH
  WAREHOUSE_SIZE = 'XSMALL'
  AUTO_SUSPEND = 60
  AUTO_RESUME = TRUE
  INITIALLY_SUSPENDED = TRUE;

-- Step 2: Create a Database
CREATE OR REPLACE DATABASE ECOMMERCE_DB;

-- Step 3: Create Schemas
CREATE OR REPLACE SCHEMA ECOMMERCE_DB.STAGING;
CREATE OR REPLACE SCHEMA ECOMMERCE_DB.TRANSFORMED;

-- Step 4: Create a Role for DBT
CREATE OR REPLACE ROLE DBT_ROLE;

-- Step 5: Create a User for DBT
CREATE OR REPLACE USER dbt_user
PASSWORD = 'StrongPassword123!'
DEFAULT_ROLE = DBT_ROLE
DEFAULT_WAREHOUSE = ECOMMERCE_WH
DEFAULT_NAMESPACE = ECOMMERCE_DB.STAGING
MUST_CHANGE_PASSWORD = TRUE;

-- Step 6: Grant role to user
GRANT ROLE DBT_ROLE TO USER dbt_user;

-- Step 7: Grant required privileges to the role
-- Grant access to warehouse
GRANT USAGE ON WAREHOUSE ECOMMERCE_WH TO ROLE DBT_ROLE;

-- Grant access to database and schemas
GRANT USAGE ON DATABASE ECOMMERCE_DB TO ROLE DBT_ROLE;
GRANT USAGE ON SCHEMA ECOMMERCE_DB.STAGING TO ROLE DBT_ROLE;
GRANT USAGE ON SCHEMA ECOMMERCE_DB.TRANSFORMED TO ROLE DBT_ROLE;

-- Grant read/write on schemas
GRANT CREATE TABLE ON SCHEMA ECOMMERCE_DB.STAGING TO ROLE DBT_ROLE;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA ECOMMERCE_DB.STAGING TO ROLE DBT_ROLE;
GRANT CREATE TABLE ON SCHEMA ECOMMERCE_DB.TRANSFORMED TO ROLE DBT_ROLE;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA ECOMMERCE_DB.TRANSFORMED TO ROLE DBT_ROLE;

-- Also grant future access so new tables are included
GRANT SELECT, INSERT, UPDATE, DELETE ON FUTURE TABLES IN SCHEMA ECOMMERCE_DB.STAGING TO ROLE DBT_ROLE;
GRANT SELECT, INSERT, UPDATE, DELETE ON FUTURE TABLES IN SCHEMA ECOMMERCE_DB.TRANSFORMED TO ROLE DBT_ROLE;

-- Allow creation of new objects
GRANT CREATE TABLE, CREATE VIEW ON SCHEMA ECOMMERCE_DB.STAGING TO ROLE DBT_ROLE;
GRANT CREATE TABLE, CREATE VIEW ON SCHEMA ECOMMERCE_DB.TRANSFORMED TO ROLE DBT_ROLE;

-- Grant usage and create schema/table privileges on the database
GRANT USAGE ON DATABASE ECOMMERCE_DB TO ROLE DBT_ROLE;
GRANT USAGE ON SCHEMA ECOMMERCE_DB.STAGING TO ROLE DBT_ROLE;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA ECOMMERCE_DB.STAGING TO ROLE DBT_ROLE;
GRANT CREATE TABLE, CREATE VIEW ON SCHEMA ECOMMERCE_DB.STAGING TO ROLE DBT_ROLE;

-- Optional but recommended: future grants
GRANT SELECT, INSERT, UPDATE, DELETE ON FUTURE TABLES IN SCHEMA ECOMMERCE_DB.STAGING TO ROLE DBT_ROLE;
GRANT CREATE TABLE, CREATE VIEW ON FUTURE SCHEMAS IN DATABASE ECOMMERCE_DB TO ROLE DBT_ROLE;
